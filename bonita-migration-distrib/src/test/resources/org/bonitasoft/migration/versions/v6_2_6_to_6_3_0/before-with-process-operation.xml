<?xml version="1.0" encoding="UTF-8"?>
<processDefinition xmlns="http://www.bonitasoft.org/ns/process/client/6.0" bos_version="6.0-SNAPSHOT" description="" displayDescription="" name="Approval_BSD" version="1.003">
  <stringIndexes>
    <stringIndex index="1"/>
    <stringIndex index="2"/>
    <stringIndex index="3"/>
    <stringIndex index="4"/>
    <stringIndex index="5"/>
  </stringIndexes>
  <flowElements>
    <transitions>
      <transition id="8444224341373271416" name="Notify cancel_-&gt;_Cancelled" source="-4863232981473855260" target="-6432263633414116404"/>
      <transition id="8983049531292368220" name="Notify Reject_-&gt;_Rejected" source="-7033842577446123688" target="-8446473019470579858"/>
      <transition id="7928879063792894587" name="Decision?_-&gt;_Notify Reject" source="-5073744529954463830" target="-7033842577446123688"/>
      <transition id="4079279116503895604" name="Decision?_-&gt;_Notify Approve" source="-5073744529954463830" target="-8051618524134055889">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="approved if" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawStatus;



PawStatus.APPROVED.getStatusId().equals(decision)</content>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
        </condition>
      </transition>
      <transition id="4486983273537322201" name="Only notified (not decision yet)?_-&gt;_Decision?" source="-7483767250699881262" target="-5073744529954463830"/>
      <transition id="6227390173416501893" name="Approve document (ENDORSEMENT)_-&gt;_Notify new readers?" source="-6244483721764461375" target="-6757258532079730945"/>
      <transition id="247685219176104686" name="Decision type?_-&gt;_Approve document (ENDORSEMENT)" source="-8857735301002221628" target="-6244483721764461375"/>
      <transition id="8358566522595882237" name="Performer type?_-&gt;_Decision type?" source="-4853102777829641927" target="-8857735301002221628"/>
      <transition id="1058165947009383241" name="Buyer decision?_-&gt;_Modify Document" source="-9034311412311222689" target="-8726032539338134141">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="save if" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawStatus;



decision.equals(PawStatus.SAVE.getStatusId())</content>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
        </condition>
      </transition>
      <transition id="1106415390683054200" name="Buyer decision ?_-&gt;_Recall" source="-5454138644782442414" target="-7630786683555758561">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="recall" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawStatus;



PawStatus.RECALL.getStatusId().equals(decision)</content>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
        </condition>
      </transition>
      <transition id="4188599158229585622" name="Remaining time_-&gt;_Approve automatically" source="-6911786250896212301" target="-5056484960605991402"/>
      <transition id="9017617765412718890" name="Modify Document_-&gt;_Buyer decision?" source="-8726032539338134141" target="-9034311412311222689"/>
      <transition id="33987063028400520" name="Notify temp readers_-&gt;_Only notified (not decision yet)?" source="-4793214544702840173" target="-7483767250699881262"/>
      <transition id="5097648419095728104" name="Notify Modification_-&gt;_Reset temp data" source="-5545640052410026423" target="-5866592026885170585"/>
      <transition id="6072645225894491903" name="Reset temp data_-&gt;_Decision type?" source="-5866592026885170585" target="-8857735301002221628"/>
      <transition id="7388716986335707926" name="Cancel / Recall Document_-&gt;_Copy of Update reference document" source="-5684764359881474313" target="-8440146352429759148"/>
      <transition id="2640281412267034269" name="Buyer decision ?_-&gt;_Notify cancel" source="-5454138644782442414" target="-4863232981473855260"/>
      <transition id="5914148668858974313" name="Buyer decision?_-&gt;_Notify Recall" source="-9034311412311222689" target="-7201930260946461143">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="recall if" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawStatus;



PawStatus.RECALL.getStatusId().equals(decision)</content>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
        </condition>
      </transition>
      <transition id="5823556763602206785" name="Notify new readers?_-&gt;_Update reference document" source="-6757258532079730945" target="-5743876393628887063"/>
      <transition id="3393046723358997647" name="Copy of Update reference document_-&gt;_Buyer decision ?" source="-8440146352429759148" target="-5454138644782442414"/>
      <transition id="6341260291925784562" name="Notify Buyer_-&gt;_Modify Document" source="-6805422535694022857" target="-8726032539338134141"/>
      <transition id="7846824731330133000" name="Buyer decision?_-&gt;_Notify Modification" source="-9034311412311222689" target="-5545640052410026423">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="continue approval if" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawStatus;



PawStatus.APPROVAL_IN_PROGRESS.getStatusId().equals(decision)</content>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
        </condition>
      </transition>
      <transition id="6516218567500348508" name="Decision?_-&gt;_Notify Buyer" source="-5073744529954463830" target="-6805422535694022857">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="back to buyer if" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawStatus;



decision.equals(PawStatus.BACK_TO_BUYER.getStatusId())</content>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
        </condition>
      </transition>
      <transition id="2146514707197899293" name="Start approval_-&gt;_set init parms" source="-5831461165192240468" target="-7937240740535008576"/>
      <transition id="6060732935121159297" name="Decision type?_-&gt;_Approve document (DECISION)" source="-8857735301002221628" target="-8257328914419345037">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="is decision if" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawDecisionType;



decisionType.equalsIgnoreCase(PawDecisionType.DECISION.getDecisionTypeId())</content>
          <expression expressionType="TYPE_VARIABLE" name="decisionType" returnType="java.lang.String">
            <content>decisionType</content>
          </expression>
        </condition>
      </transition>
      <transition id="1899752015532606001" name="Only notified (not decision yet)?_-&gt;_Approve document (DECISION)" source="-7483767250699881262" target="-8257328914419345037">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="checkIfNotifyAndTypeDecision" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawDecisionType;



return decision.equals('NOTIFY') &amp;&amp; decisionType.equals(PawDecisionType.DECISION.getDecisionTypeId());</content>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="decisionType" returnType="java.lang.String">
            <content>decisionType</content>
          </expression>
        </condition>
      </transition>
      <transition id="5854302617790820562" name="Approve document (DECISION)_-&gt;_Notify new readers?" source="-8257328914419345037" target="-6757258532079730945"/>
      <transition id="12296300144014775" name="Notify Approve_-&gt;_Approved" source="-8051618524134055889" target="-7041263772579361788"/>
      <transition id="2921976654775107366" name="Update reference document_-&gt;_Only notified (not decision yet)?" source="-5743876393628887063" target="-7483767250699881262"/>
      <transition id="6673101584410525057" name="Only notified (not decision yet)?_-&gt;_Approve document (ENDORSEMENT)" source="-7483767250699881262" target="-6244483721764461375">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="checkIfNotifyAndTypeEndorsement" returnType="java.lang.Boolean">
          <content>import hu.mol.capgemini.enums.PawDecisionType;



return decision.equals('NOTIFY') &amp;&amp; decisionType.equals(PawDecisionType.ENDORSEMENT.getDecisionTypeId());</content>
          <expression expressionType="TYPE_VARIABLE" name="decisionType" returnType="java.lang.String">
            <content>decisionType</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
        </condition>
      </transition>
      <transition id="3360247391569688287" name="set init parms_-&gt;_Performer type?" source="-7937240740535008576" target="-4853102777829641927"/>
      <transition id="4859120828444622406" name="Buyer decision?_-&gt;_Notify cancel" source="-9034311412311222689" target="-4863232981473855260"/>
      <transition id="6605133078376070701" name="Notify new readers?_-&gt;_Notify temp readers" source="-6757258532079730945" target="-4793214544702840173">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="checkIfNotify" returnType="java.lang.Boolean">
          <content>return decision=='NOTIFY'</content>
          <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
            <content>decision</content>
          </expression>
        </condition>
      </transition>
      <transition id="8603990903615799487" name="Notify Recall_-&gt;_Recall" source="-7201930260946461143" target="-7630786683555758561"/>
      <transition id="4869871656688138994" name="Performer type?_-&gt;_Cancel / Recall Document" source="-4853102777829641927" target="-5684764359881474313">
        <condition expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="is a buyer if" returnType="java.lang.Boolean">
          <content>/* buyerId.equals(approvalPerformer.getApproverId()) */



return approvalPerformer.getDecisionStatus().equals("BUYER");</content>
          <expression expressionType="TYPE_VARIABLE" name="approvalPerformer" returnType="hu.mol.capgemini.paw.Approver">
            <content>approvalPerformer</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="buyerId" returnType="java.lang.String">
            <content>buyerId</content>
          </expression>
        </condition>
      </transition>
      <transition id="5269428346146962211" name="Approve automatically_-&gt;_Approved automatically" source="-5056484960605991402" target="-8151172276074376967"/>
    </transitions>
    <connectors>
      <connector activationEvent="ON_FINISH" connectorId="scripting-groovy" failAction="IGNORE" name="create approvalPerformerDecision" version="1.0.0">
        <inputs>
          <input name="script">
            <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="approvalDecision" returnType="java.lang.Object">
              <content>import hu.mol.capgemini.paw.ApproverDecision;



import java.util.logging.Logger;



Logger logger= Logger.getLogger("org.bonitasoft");

logger.severe("End calcul approverDecision");





ApproverDecision approverDecision = new ApproverDecision();

approverDecision.setApproverId( approvalPerformer.getApproverId());

approverDecision.setDecisionStatus(decision);

approverDecision.setDecisionDate(new Date());

return approverDecision</content>
              <expression expressionType="TYPE_VARIABLE" name="approvalPerformer" returnType="hu.mol.capgemini.paw.Approver">
                <content>approvalPerformer</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="approverDecision" returnType="hu.mol.capgemini.paw.ApproverDecision">
                <content>approverDecision</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
                <content>decision</content>
              </expression>
            </expression>
          </input>
        </inputs>
        <outputs>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="approverDecision"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="resultEndConnector" returnType="hu.mol.capgemini.paw.ApproverDecision">
              <content>

return (hu.mol.capgemini.paw.ApproverDecision) result;</content>
              <expression expressionType="TYPE_INPUT" name="result" returnType="java.lang.Object">
                <content>result</content>
              </expression>
            </rightOperand>
          </operation>
        </outputs>
      </connector>
    </connectors>
    <dataDefinitions>
      <dataDefinition className="java.lang.Long" name="remainingTimeInMiliseconds" transient="false"/>
      <textDataDefinition className="java.lang.String" longText="true" name="documentType" transient="false"/>
      <textDataDefinition className="java.lang.String" longText="true" name="buyerId" transient="false"/>
      <dataDefinition className="hu.mol.capgemini.paw.Approver" name="approvalPerformer" transient="false"/>
      <textDataDefinition className="java.lang.String" longText="true" name="decision" transient="false"/>
      <textDataDefinition className="java.lang.String" longText="true" name="decisionType" transient="false"/>
      <dataDefinition className="hu.mol.capgemini.paw.ApproverDecision" name="approverDecision" transient="false"/>
      <dataDefinition className="java.lang.Integer" name="roundNumber" transient="false"/>
      <dataDefinition className="hu.mol.capgemini.paw.BSD" name="bsdDocument" transient="false"/>
      <dataDefinition className="hu.mol.capgemini.paw.Note" name="tempNote" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="newNote" returnType="hu.mol.capgemini.paw.Note">
          <content>import hu.mol.capgemini.paw.Note;



return new Note();</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.util.Collection" name="tempAttachments" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="newListAttachments" returnType="java.util.List">
          <content>return []</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.util.Collection" name="tempReaders" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="newListReaders" returnType="java.util.List">
          <content>return []</content>
        </defaultValue>
      </dataDefinition>
      <textDataDefinition className="java.lang.String" longText="true" name="tempStatusId" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="APPROVAL_IN_PROGRESS" returnType="java.lang.String">
          <content>import hu.mol.capgemini.enums.PawStatus;



return PawStatus.APPROVAL_IN_PROGRESS.getStatusId()</content>
        </defaultValue>
      </textDataDefinition>
      <dataDefinition className="java.util.Collection" name="tempCommitteeMembers" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="empty list" returnType="java.util.List">
          <content>[["dummy":""]]</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.util.Collection" name="tempApprovers" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="empty list" returnType="java.util.List">
          <content>[]</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.lang.Boolean" name="withBSD" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="false" returnType="java.lang.Boolean">
          <content>false</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.lang.Boolean" name="withoutBSD" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="false" returnType="java.lang.Boolean">
          <content>false</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.util.Collection" name="formTempReaders" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="empty list" returnType="java.util.List">
          <content>[]</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.lang.Boolean" name="sendApprovalRequest" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="true" returnType="java.lang.Boolean">
          <content>true</content>
        </defaultValue>
      </dataDefinition>
      <textDataDefinition className="java.lang.String" longText="true" name="username" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="empty string" returnType="java.lang.String">
          <content>""</content>
        </defaultValue>
      </textDataDefinition>
      <dataDefinition className="java.util.Collection" name="tempDocumentAttachment" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="empty list" returnType="java.util.List">
          <content>[]</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.lang.Long" name="emailUserId" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="0" returnType="java.lang.Long">
          <content>0L</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.lang.Long" name="approvalProcessId" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="0" returnType="java.lang.Long">
          <content>0L</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.util.Collection" name="bsdAttachments" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="rmpty" returnType="java.util.List">
          <content>[]</content>
        </defaultValue>
      </dataDefinition>
      <dataDefinition className="java.util.Collection" name="filelist" transient="false">
        <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="empty" returnType="java.util.List">
          <content>[]</content>
        </defaultValue>
      </dataDefinition>
    </dataDefinitions>
    <documentDefinitions/>
    <flowNodes>
      <userTask actorName="Buyer" expectedDuration="0" id="-5684764359881474313" name="Cancel / Recall Document" priority="NORMAL">
        <displayName expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="setTaskName" returnType="java.lang.String">
          <content>String docTypeLetter = "";



return "Cancel/Recall "+bsdDocument.getDocumentTypeId()+"("+docTypeLetter+bsdDocument.getDocumentId() + ")";</content>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayName>
        <displayDescription expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getDescription" returnType="java.lang.String">
          <content>import hu.mol.capgemini.common.bonita.FormScripts;



String description = "ID: ";



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

//description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;</content>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
            <content>taskAssigneeId</content>
          </expression>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
            <content>apiAccessor</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayDescription>
        <displayDescriptionAfterCompletion expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getDescription" returnType="java.lang.String">
          <content>import hu.mol.capgemini.common.bonita.FormScripts;



String description;



// Request

if (bsdDocument.getDocumentTypeId().equals("BSD")) {description = "ID: B";}

if (bsdDocument.getDocumentTypeId().equals("SSD")) {description = "ID: S";}

if (bsdDocument.getDocumentTypeId().equals("LVP")) {description = "ID: L";}



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

//description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;</content>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
            <content>taskAssigneeId</content>
          </expression>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
            <content>apiAccessor</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayDescriptionAfterCompletion>
        <incomingTransition idref="4869871656688138994"/>
        <outgoingTransition idref="7388716986335707926"/>
        <connector activationEvent="ON_FINISH" connectorId="PAW-CalculDocumentId" failAction="IGNORE" name="calculDocumentId" version="1.0.0">
          <inputs>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="processInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getprocessInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
          </inputs>
          <outputs>
            <operation operatorType="ASSIGNMENT">
              <leftOperand name="bsdDocument"/>
              <rightOperand expressionType="TYPE_INPUT" interpreter="" name="bsdDocumentUpdated" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocumentUpdated</content>
              </rightOperand>
            </operation>
          </outputs>
        </connector>
        <connector activationEvent="ON_FINISH" connectorId="PAW-UpdateDocument" failAction="IGNORE" name="saveDocument" version="1.0.0">
          <inputs>
            <input name="documentType">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="documentType" returnType="java.lang.String">
                <content>documentType</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="modifierUserName">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getuserName" returnType="java.lang.String">
                <content>import org.bonitasoft.engine.api.IdentityAPI;

import org.bonitasoft.engine.identity.User;



IdentityAPI identityAPI = apiAccessor.getIdentityAPI();



User user = identityAPI.getUser(taskAssigneeId);

if (user!=null)

  return user.getUserName();

return "Unknown";</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
                  <content>taskAssigneeId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions/>
        <operations/>
        <boundaryEvents/>
        <userFilter name="Get buyer and substitutor" userFilterId="ApprovalUserFilter" version="1.0.0">
          <inputs>
            <input name="firstUser">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="buyerId" returnType="java.lang.String">
                <content>buyerId</content>
              </expression>
            </input>
          </inputs>
        </userFilter>
      </userTask>
      <automaticTask id="-7201930260946461143" name="Notify Recall">
        <incomingTransition idref="5914148668858974313"/>
        <outgoingTransition idref="8603990903615799487"/>
        <dataDefinitions/>
        <operations/>
        <boundaryEvents/>
      </automaticTask>
      <automaticTask id="-4863232981473855260" name="Notify cancel">
        <incomingTransition idref="4859120828444622406"/>
        <incomingTransition idref="2640281412267034269"/>
        <outgoingTransition idref="8444224341373271416"/>
        <dataDefinitions/>
        <operations/>
        <boundaryEvents/>
      </automaticTask>
      <automaticTask id="-5545640052410026423" name="Notify Modification">
        <incomingTransition idref="7846824731330133000"/>
        <outgoingTransition idref="5097648419095728104"/>
        <connector activationEvent="ON_FINISH" connectorId="PAWnotifyUserByEmail" failAction="IGNORE" name="Email - Information on document modification - Approvers (3)" version="1.0.0">
          <inputs>
            <input name="overviewLink">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="link" returnType="java.lang.String">
                <content>import hu.mol.capgemini.paw.BSD;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");

ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

String value = null;

if(parentProcessInstanceId != null)

{

	value = processAPI.getProcessDataInstance("overviewLink", parentProcessInstanceId).getValue();

}

logger.info("overview value=" + value);

return value;</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
            <input name="isSimulate">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="emailSimulation" returnType="java.lang.Boolean">
                <content>emailSimulation</content>
              </expression>
            </input>
            <input name="notifyApproversRoundCompleted">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="true" returnType="java.lang.Boolean">
                <content>true</content>
              </expression>
            </input>
            <input name="documentType">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="BSD" returnType="java.lang.String">
                <content>BSD</content>
              </expression>
            </input>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="roundNumber">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="maskEmail">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="false" returnType="java.lang.Boolean">
                <content>false</content>
              </expression>
            </input>
            <input name="notifyApproversRoundInProgress">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="true" returnType="java.lang.Boolean">
                <content>true</content>
              </expression>
            </input>
            <input name="emailTemplateId">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="3" returnType="java.lang.String">
                <content>3</content>
              </expression>
            </input>
            <input name="activityInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="activityInstanceId" returnType="java.lang.Long">
                <content>activityInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="activityInstanceId" returnType="java.lang.Long">
                  <content>activityInstanceId</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <connector activationEvent="ON_FINISH" connectorId="PAWnotifyUserByEmail" failAction="IGNORE" name="Email - Notify Readers (5)" version="1.0.0">
          <inputs>
            <input name="overviewLink">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="get overview link from parent" returnType="java.lang.String">
                <content>import hu.mol.capgemini.paw.BSD;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");

ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

String value = null;

if(parentProcessInstanceId != null)

{

	value = processAPI.getProcessDataInstance("overviewLink", parentProcessInstanceId).getValue();

}

logger.info("overview value=" + value);

return value;</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
            <input name="isSimulate">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="emailSimulation" returnType="java.lang.Boolean">
                <content>emailSimulation</content>
              </expression>
            </input>
            <input name="documentType">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="documentTypeId" returnType="java.lang.String">
                <content>documentTypeId</content>
              </expression>
            </input>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="roundNumber">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="maskEmail">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="false" returnType="java.lang.Boolean">
                <content>false</content>
              </expression>
            </input>
            <input name="usersListToSend">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="tempReaders" returnType="java.util.List">
                <content>tempReaders</content>
              </expression>
            </input>
            <input name="emailTemplateId">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="5" returnType="java.lang.String">
                <content>5</content>
              </expression>
            </input>
            <input name="activityInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="activityInstanceId" returnType="java.lang.Long">
                <content>activityInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="activityInstanceId" returnType="java.lang.Long">
                  <content>activityInstanceId</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions/>
        <operations>
          <operation operator="setStatusId:java.lang.String" operatorType="JAVA_METHOD">
            <leftOperand name="bsdDocument"/>
            <rightOperand expressionType="TYPE_VARIABLE" interpreter="" name="decision" returnType="java.lang.String">
              <content>decision</content>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
      </automaticTask>
      <automaticTask id="-5866592026885170585" name="Reset temp data">
        <incomingTransition idref="5097648419095728104"/>
        <outgoingTransition idref="6072645225894491903"/>
        <dataDefinitions/>
        <operations>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="tempNote"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="newNote" returnType="hu.mol.capgemini.paw.Note">
              <content>import hu.mol.capgemini.paw.Note;



return new Note();</content>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="tempAttachments"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="newListAttachments" returnType="java.util.List">
              <content>return [];</content>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="tempStatusId"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="APPROVED" returnType="java.lang.String">
              <content>import hu.mol.capgemini.enums.PawStatus;



return PawStatus.APPROVED.getStatusId();</content>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="formTempReaders"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="empty" returnType="java.util.List">
              <content>[]</content>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
      </automaticTask>
      <automaticTask id="-8440146352429759148" name="Copy of Update reference document">
        <incomingTransition idref="7388716986335707926"/>
        <outgoingTransition idref="3393046723358997647"/>
        <connector activationEvent="ON_FINISH" connectorId="updatePawReferenceDocument" failAction="IGNORE" name="Update added data by approver" version="1.0.0">
          <inputs>
            <input name="newNotes">
              <expression expressionType="TYPE_LIST" name="List of expression containing the following expressions: ()." returnType="java.util.List">
                <content>List of expression containing the following expressions: ().</content>
              </expression>
            </input>
            <input name="newNote">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="tempNote" returnType="hu.mol.capgemini.paw.Note">
                <content>return tempNote</content>
                <expression expressionType="TYPE_VARIABLE" name="tempNote" returnType="hu.mol.capgemini.paw.Note">
                  <content>tempNote</content>
                </expression>
              </expression>
            </input>
            <input name="newReaders">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="tempReaders" returnType="java.util.List">
                <content>tempReaders</content>
              </expression>
            </input>
            <input name="newAttachments">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="tempAttachments" returnType="java.util.List">
                <content>tempAttachments</content>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions/>
        <operations>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="tempStatusId"/>
            <rightOperand expressionType="TYPE_VARIABLE" interpreter="" name="decision" returnType="java.lang.String">
              <content>decision</content>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
      </automaticTask>
      <automaticTask id="-6805422535694022857" name="Notify Buyer">
        <incomingTransition idref="6516218567500348508"/>
        <outgoingTransition idref="6341260291925784562"/>
        <connector activationEvent="ON_FINISH" connectorId="PAW-UpdateDocument" failAction="IGNORE" name="SaveDocumentBackToBuyer" version="1.0.0">
          <inputs>
            <input name="documentType">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="documentTypeId" returnType="java.lang.String">
                <content>documentTypeId</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="modifierUserName">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getUserName" returnType="java.lang.String">
                <content>if (approvalPerformer.getApproverId() != null)

{ 

	return approvalPerformer.getApproverId();

}

return "Unknown";</content>
                <expression expressionType="TYPE_VARIABLE" name="approvalPerformer" returnType="hu.mol.capgemini.paw.Approver">
                  <content>approvalPerformer</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions/>
        <operations>
          <operation operator="setStatusId:java.lang.String" operatorType="JAVA_METHOD">
            <leftOperand name="bsdDocument"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="back to buyer" returnType="java.lang.String">
              <content>import hu.mol.capgemini.enums.PawStatus;



return PawStatus.BACK_TO_BUYER.getStatusId();</content>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="withBSD"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="withsd" returnType="java.lang.Boolean">
              <content>if(bsdDocument.getBsdDocumentId()==null)

return false;

else

return !(bsdDocument.getBsdDocumentId().isEmpty());</content>
              <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="withoutBSD"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="without" returnType="java.lang.Boolean">
              <content>if(bsdDocument.getBsdDocumentId()==null)

return true;

else

return bsdDocument.getBsdDocumentId().isEmpty();</content>
              <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="formTempReaders"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="empty" returnType="java.util.List">
              <content>[]</content>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
      </automaticTask>
      <userTask actorName="Buyer" expectedDuration="0" id="-8726032539338134141" name="Modify Document" priority="NORMAL">
        <displayName expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="setTaskName" returnType="java.lang.String">
          <content>String docTypeLetter = "";



return "Modify "+bsdDocument.getDocumentTypeId()+"("+docTypeLetter+bsdDocument.getDocumentId() + ")";</content>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayName>
        <displayDescription expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getDescription" returnType="java.lang.String">
          <content>import hu.mol.capgemini.common.bonita.FormScripts;



String description = "ID: ";



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

//description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;</content>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
            <content>taskAssigneeId</content>
          </expression>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
            <content>apiAccessor</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayDescription>
        <displayDescriptionAfterCompletion expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getDescription" returnType="java.lang.String">
          <content>import hu.mol.capgemini.common.bonita.FormScripts;



String description;



// Request

if (bsdDocument.getDocumentTypeId().equals("BSD")) {description = "ID: B";}

if (bsdDocument.getDocumentTypeId().equals("SSD")) {description = "ID: S";}

if (bsdDocument.getDocumentTypeId().equals("LVP")) {description = "ID: L";}



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

//description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;</content>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
            <content>taskAssigneeId</content>
          </expression>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
            <content>apiAccessor</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayDescriptionAfterCompletion>
        <incomingTransition idref="1058165947009383241"/>
        <incomingTransition idref="6341260291925784562"/>
        <outgoingTransition idref="9017617765412718890"/>
        <connector activationEvent="ON_FINISH" connectorId="PAW-CalculDocumentId" failAction="IGNORE" name="calculDocumentId" version="1.0.0">
          <inputs>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="processInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getprocessInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
          </inputs>
          <outputs>
            <operation operatorType="ASSIGNMENT">
              <leftOperand name="bsdDocument"/>
              <rightOperand expressionType="TYPE_INPUT" interpreter="" name="bsdDocumentUpdated" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocumentUpdated</content>
              </rightOperand>
            </operation>
          </outputs>
        </connector>
        <connector activationEvent="ON_FINISH" connectorId="PAW-UpdateDocument" failAction="IGNORE" name="saveDocument" version="1.0.0">
          <inputs>
            <input name="documentType">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="documentType" returnType="java.lang.String">
                <content>documentType</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="modifierUserName">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getuserName" returnType="java.lang.String">
                <content>import org.bonitasoft.engine.api.IdentityAPI;

import org.bonitasoft.engine.identity.User;



IdentityAPI identityAPI = apiAccessor.getIdentityAPI();



User user = identityAPI.getUser(taskAssigneeId);

if (user!=null)

  return user.getUserName();

return "Unknown";</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
                  <content>taskAssigneeId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <connector activationEvent="ON_ENTER" connectorId="PAWnotifyUserByEmail" failAction="IGNORE" name="Email - Request for completion of a task (6)" version="1.0.0">
          <inputs>
            <input name="overviewLink">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="link" returnType="java.lang.String">
                <content>import hu.mol.capgemini.paw.BSD;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");

ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

String value = null;

if(parentProcessInstanceId != null)

{

	value = processAPI.getProcessDataInstance("overviewLink", parentProcessInstanceId).getValue();

}

logger.info("overview value=" + value);

return value;</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
            <input name="isSimulate">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="emailSimulation" returnType="java.lang.Boolean">
                <content>emailSimulation</content>
              </expression>
            </input>
            <input name="documentType">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="documentTypeId" returnType="java.lang.String">
                <content>documentTypeId</content>
              </expression>
            </input>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="roundNumber">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="notifyBuyer">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="true" returnType="java.lang.Boolean">
                <content>true</content>
              </expression>
            </input>
            <input name="maskEmail">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="false" returnType="java.lang.Boolean">
                <content>false</content>
              </expression>
            </input>
            <input name="emailTemplateId">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="6" returnType="java.lang.String">
                <content>6</content>
              </expression>
            </input>
            <input name="activityInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="activityInstanceId" returnType="java.lang.Long">
                <content>activityInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="activityInstanceId" returnType="java.lang.Long">
                  <content>activityInstanceId</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <connector activationEvent="ON_FINISH" connectorId="scripting-groovy" failAction="IGNORE" name="synchronize bsdDocument to root process" version="1.0.0">
          <inputs>
            <input name="script">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="do synchronization" returnType="java.lang.Object">
                <content>import hu.mol.capgemini.paw.BSD;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;



ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

if(parentProcessInstanceId != null)

{

//	processAPI.updateProcessDataInstance("bsdDocument", processInstanceId, processAPI.getProcessDataInstance("bsdDocument", parentProcessInstanceId).getValue());

	processAPI.updateProcessDataInstance("bsdDocument", parentProcessInstanceId, bsdDocument);

}</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
                <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                  <content>bsdDocument</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions/>
        <operations>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="tempReaders"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="get temp reader list" returnType="java.util.List">
              <content>List&lt;String&gt; result = [];

for (int i = 0; i &lt; formTempReaders.size(); i++) {

	result.add(formTempReaders.get(i).get("readerName"));

}

return result;</content>
              <expression expressionType="TYPE_VARIABLE" name="formTempReaders" returnType="java.util.List">
                <content>formTempReaders</content>
              </expression>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="bsdDocument"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="update bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
              <content>import groovyjarjarantlr.Utils;

import hu.mol.capgemini.common.bonita.FormScripts;

import hu.mol.capgemini.enums.PawStatus;

import hu.mol.capgemini.paw.ApprovalRound;

import hu.mol.capgemini.paw.BSD;

import hu.mol.capgemini.paw.DocumentAttachment;

import hu.mol.capgemini.paw.Note;



import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");





logger.info(username + " OPERATION STARTED");



// ha notify, akkor nem frissitunk

if (decision.equals("NOTIFY")) { return bsdDocument; }





ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

BSD tmp = (BSD)processAPI.getProcessDataInstance("bsdDocument", parentProcessInstanceId).getValue();



/**********************/

/* NOTES              */

/**********************/

if (tempNote != null) {

	logger.info(username + " synchronizing notes ...");

	bsdDocument.setNotes(FormScripts.addNoteToList(tmp.getNotes(), tempNote.getNote(), tempNote.getAuthorId(), true));

	logger.info(username + " notes synchronized");

}



/**********************/

/* ATTACHMENTS        */

/**********************/

/*

logger.info(username + " synchronizing attachments ...");

List&lt;DocumentAttachment&gt; attachments = tmp.getAttachments();

if (tempDocumentAttachment.size() &gt; 0) {

	for (int i = 0; i &lt; tempDocumentAttachment.size(); i++) {

		attachments.add(tempDocumentAttachment.get(i));

	}

}

bsdDocument.setAttachments(attachments);

logger.info(username + " attachments synchronized");

*/



return bsdDocument;</content>
              <expression expressionType="TYPE_VARIABLE" name="username" returnType="java.lang.String">
                <content>username</content>
              </expression>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="tempDocumentAttachment" returnType="java.util.List">
                <content>tempDocumentAttachment</content>
              </expression>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                <content>apiAccessor</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="tempNote" returnType="hu.mol.capgemini.paw.Note">
                <content>tempNote</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
                <content>decision</content>
              </expression>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
        <userFilter name="Get buyer and substitutor" userFilterId="ApprovalUserFilter" version="1.0.0">
          <inputs>
            <input name="firstUser">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="buyerId" returnType="java.lang.String">
                <content>buyerId</content>
              </expression>
            </input>
          </inputs>
        </userFilter>
      </userTask>
      <automaticTask id="-5056484960605991402" name="Approve automatically">
        <incomingTransition idref="4188599158229585622"/>
        <outgoingTransition idref="5269428346146962211"/>
        <connector activationEvent="ON_FINISH" connectorId="PAW-UpdateDocument" failAction="IGNORE" name="updateDocumentAUTOMATIC" version="1.0.0">
          <inputs>
            <input name="documentType">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="documentType" returnType="java.lang.String">
                <content>documentType</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="modifierUserName">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="SYSTEM" returnType="java.lang.String">
                <content>SYSTEM</content>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions/>
        <operations>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="decision"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="APPROVED" returnType="java.lang.String">
              <content>import hu.mol.capgemini.enums.PawStatus;



return PawStatus.APPROVED.getStatusId();</content>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="bsdDocument"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="update bsdDocument approvals" returnType="hu.mol.capgemini.paw.BSD">
              <content>import hu.mol.capgemini.paw.ApprovalRound;

import hu.mol.capgemini.paw.BSD;

import java.util.logging.Logger;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;



Logger logger = Logger.getLogger("groovy");



ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

BSD tmp = (BSD)processAPI.getProcessDataInstance("bsdDocument", parentProcessInstanceId).getValue();



bsdDocument = tmp;



List&lt;ApprovalRound&gt; arlist = bsdDocument.getApprovalRounds();

ApprovalRound ar = bsdDocument.getApprovalRounds().get(roundNumber);



logger.info("bsd endorsement - approval round approvers BEFORE =" + ar.getApprovers());



for (int i = 0; i &lt; ar.getApprovers().size(); i++) {

	if (ar.getApprovers().get(i).getDecisionDate() == null) {

		ar.getApprovers().get(i).setDecisionDate(new Date());

	}

}



logger.info("bsd endorsement - approval round approvers AFTER =" + ar.getApprovers());



arlist.remove(roundNumber);

arlist.add(roundNumber, ar);

bsdDocument.setApprovalRounds(arlist);

return bsdDocument;</content>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                <content>apiAccessor</content>
              </expression>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
      </automaticTask>
      <userTask actorName="Approver" expectedDuration="0" id="-8257328914419345037" name="Approve document (DECISION)" priority="NORMAL">
        <displayName expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="setTaskName" returnType="java.lang.String">
          <content>String docTypeLetter = "";



return "Approve "+bsdDocument.getDocumentTypeId()+" (DECISION) ("+docTypeLetter+bsdDocument.getDocumentId() + ")";</content>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayName>
        <displayDescription expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getDescription" returnType="java.lang.String">
          <content>import hu.mol.capgemini.common.bonita.FormScripts;



String description = "ID: ";



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

//description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;



/*

import hu.mol.capgemini.common.bonita.FormScripts;



String description;



// Request

if (bsdDocument.getDocumentTypeId().equals("BSD")) {description = "ID: B";}

if (bsdDocument.getDocumentTypeId().equals("SSD")) {description = "ID: S";}

if (bsdDocument.getDocumentTypeId().equals("LVP")) {description = "ID: L";}



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;

*/</content>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
            <content>taskAssigneeId</content>
          </expression>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
            <content>apiAccessor</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayDescription>
        <displayDescriptionAfterCompletion expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getDescription" returnType="java.lang.String">
          <content>import hu.mol.capgemini.common.bonita.FormScripts;



String description;



// Request

if (bsdDocument.getDocumentTypeId().equals("BSD")) {description = "ID: B";}

if (bsdDocument.getDocumentTypeId().equals("SSD")) {description = "ID: S";}

if (bsdDocument.getDocumentTypeId().equals("LVP")) {description = "ID: L";}



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

//description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;</content>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
            <content>taskAssigneeId</content>
          </expression>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
            <content>apiAccessor</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayDescriptionAfterCompletion>
        <incomingTransition idref="6060732935121159297"/>
        <incomingTransition idref="1899752015532606001"/>
        <outgoingTransition idref="5854302617790820562"/>
        <connector activationEvent="ON_FINISH" connectorId="PAW-CalculDocumentId" failAction="IGNORE" name="calculDocumentId" version="1.0.0">
          <inputs>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="processInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getProcessInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
          </inputs>
          <outputs>
            <operation operatorType="ASSIGNMENT">
              <leftOperand name="bsdDocument"/>
              <rightOperand expressionType="TYPE_INPUT" interpreter="" name="bsdDocumentUpdated" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocumentUpdated</content>
              </rightOperand>
            </operation>
          </outputs>
        </connector>
        <connector activationEvent="ON_ENTER" connectorId="PAWnotifyUserByEmail" failAction="IGNORE" name="Email - Approval request (1)" version="1.0.0">
          <inputs>
            <input name="isSimulate">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="emailSimulation" returnType="java.lang.Boolean">
                <content>emailSimulation</content>
              </expression>
            </input>
            <input name="documentType">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="documentTypeId" returnType="java.lang.String">
                <content>documentTypeId</content>
              </expression>
            </input>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="roundNumber">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="maskEmail">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="see script ..." returnType="java.lang.Boolean">
                <content>// ha a sendApprovalRequest true, akkor kell kuldeni ezt az emailt.

if (sendApprovalRequest) { return false; }

return true;</content>
                <expression expressionType="TYPE_VARIABLE" name="sendApprovalRequest" returnType="java.lang.Boolean">
                  <content>sendApprovalRequest</content>
                </expression>
              </expression>
            </input>
            <input name="usersListToSend">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="current approver" returnType="java.util.List">
                <content>return [approvalPerformer.getApproverId()]</content>
                <expression expressionType="TYPE_VARIABLE" name="approvalPerformer" returnType="hu.mol.capgemini.paw.Approver">
                  <content>approvalPerformer</content>
                </expression>
              </expression>
            </input>
            <input name="emailTemplateId">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="1" returnType="java.lang.String">
                <content>1</content>
              </expression>
            </input>
            <input name="activityInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="activityInstanceId" returnType="java.lang.Long">
                <content>activityInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="activityInstanceId" returnType="java.lang.Long">
                  <content>activityInstanceId</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <connector activationEvent="ON_FINISH" connectorId="PAW-UpdateDocument" failAction="IGNORE" name="saveDocumentDECISION" version="1.0.0">
          <inputs>
            <input name="documentType">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="documentType" returnType="java.lang.String">
                <content>documentType</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="modifierUserName">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getuserName" returnType="java.lang.String">
                <content>import org.bonitasoft.engine.api.IdentityAPI;

import org.bonitasoft.engine.identity.User;



IdentityAPI identityAPI = apiAccessor.getIdentityAPI();



User user = identityAPI.getUser(taskAssigneeId);

if (user!=null)

  return user.getUserName();

return "Unknown";</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
                  <content>taskAssigneeId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <connector activationEvent="ON_FINISH" connectorId="scripting-groovy" failAction="IGNORE" name="synchronize bsdDocument with root process" version="1.0.0">
          <inputs>
            <input name="script">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="do synchronization" returnType="java.lang.Object">
                <content>import hu.mol.capgemini.paw.BSD;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;



ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

if(parentProcessInstanceId != null)

{

//	processAPI.updateProcessDataInstance("bsdDocument", processInstanceId, processAPI.getProcessDataInstance("bsdDocument", parentProcessInstanceId).getValue());

	processAPI.updateProcessDataInstance("bsdDocument", parentProcessInstanceId, bsdDocument);

}</content>
                <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                  <content>bsdDocument</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions>
          <dataDefinition className="java.util.Date" name="startDate" transient="false">
            <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="Now" returnType="java.util.Date">
              <content>new Date()</content>
            </defaultValue>
          </dataDefinition>
        </dataDefinitions>
        <operations>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="remainingTimeInMiliseconds"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="updateRemainingTimeAfterDecision" returnType="java.lang.Long">
              <content>Long executionT = new Date().getTime() - startDate.getTime();

return remainingTimeInMiliseconds-executionT;</content>
              <expression expressionType="TYPE_VARIABLE" name="startDate" returnType="java.util.Date">
                <content>startDate</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="remainingTimeInMiliseconds" returnType="java.lang.Long">
                <content>remainingTimeInMiliseconds</content>
              </expression>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="sendApprovalRequest"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="false" returnType="java.lang.Boolean">
              <content>false</content>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="bsdDocument"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="update bsddocument" returnType="hu.mol.capgemini.paw.BSD">
              <content>import groovyjarjarantlr.Utils;

import hu.mol.capgemini.common.bonita.FormScripts;

import hu.mol.capgemini.enums.PawStatus;

import hu.mol.capgemini.paw.ApprovalRound;

import hu.mol.capgemini.paw.BSD;

import hu.mol.capgemini.paw.DocumentAttachment;

import hu.mol.capgemini.paw.Note;



import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");





logger.info(username + " OPERATION STARTED");



// ha notify, akkor nem frissitunk

if (decision.equals("NOTIFY")) { return bsdDocument; }





ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

BSD tmp = (BSD)processAPI.getProcessDataInstance("bsdDocument", parentProcessInstanceId).getValue();



/**********************/

/* NOTES              */

/**********************/

if (tempNote != null) {

	logger.info(username + " synchronizing notes ...");

	bsdDocument.setNotes(FormScripts.addNoteToList(tmp.getNotes(), tempNote.getNote(), tempNote.getAuthorId(), true));

	logger.info(username + " notes synchronized");

}



/**********************/

/* APPROVAL DATE      */

/**********************/

logger.info(username + " synchronizing approvers ...");

List&lt;ApprovalRound&gt; arlist = tmp.getApprovalRounds();

if (decision.equals(PawStatus.APPROVED.getStatusId())) {

	ApprovalRound ar = arlist.get(roundNumber);

	logger.info(username + " round approvers BEFORE=" + ar.getApprovers());

	for (int i = 0; i &lt; ar.getApprovers().size(); i++) {

		if (ar.getApprovers().get(i).getApproverId().equals(username)) {

			ar.getApprovers().get(i).setDecisionDate(new Date());

		}

	}

	logger.info(username + " round approvers AFTER=" + ar.getApprovers());

	arlist.remove(roundNumber);

	arlist.add(roundNumber, ar);

}

bsdDocument.setApprovalRounds(arlist);

logger.info(username + " approvers synchronized");



/**********************/

/* ATTACHMENTS        */

/**********************/

/*

logger.info(username + " synchronizing attachments ...");

List&lt;DocumentAttachment&gt; attachments = tmp.getAttachments();

if (tempDocumentAttachment.size() &gt; 0) {

	for (int i = 0; i &lt; tempDocumentAttachment.size(); i++) {

		attachments.add(tempDocumentAttachment.get(i));

	}

}

bsdDocument.setAttachments(attachments);

logger.info(username + " attachments synchronized");

*/

return bsdDocument;</content>
              <expression expressionType="TYPE_VARIABLE" name="username" returnType="java.lang.String">
                <content>username</content>
              </expression>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="tempDocumentAttachment" returnType="java.util.List">
                <content>tempDocumentAttachment</content>
              </expression>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                <content>apiAccessor</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="tempNote" returnType="hu.mol.capgemini.paw.Note">
                <content>tempNote</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
                <content>decision</content>
              </expression>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
        <userFilter name="Get approver and substitutor" userFilterId="ApprovalUserFilter" version="1.0.0">
          <inputs>
            <input name="firstUser">
              <expression expressionType="TYPE_JAVA_METHOD_CALL" interpreter="" name="approvalPerformer - hu.mol.capgemini.paw.Approver#getApproverId" returnType="java.lang.String">
                <content>getApproverId</content>
                <expression expressionType="TYPE_VARIABLE" name="approvalPerformer" returnType="hu.mol.capgemini.paw.Approver">
                  <content>approvalPerformer</content>
                </expression>
              </expression>
            </input>
          </inputs>
        </userFilter>
      </userTask>
      <automaticTask id="-8051618524134055889" name="Notify Approve">
        <incomingTransition idref="4079279116503895604"/>
        <outgoingTransition idref="12296300144014775"/>
        <connector activationEvent="ON_FINISH" connectorId="PAWnotifyUserByEmail" failAction="IGNORE" name="Email - Notify approvers about current approval (7)" version="1.0.0">
          <inputs>
            <input name="overviewLink">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="link to parent Overview" returnType="java.lang.String">
                <content>import hu.mol.capgemini.paw.BSD;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");

ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

String value = null;

if(parentProcessInstanceId != null)

{

	value = processAPI.getProcessDataInstance("overviewLink", parentProcessInstanceId).getValue();

}

logger.info("overview value=" + value);

return value;</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
            <input name="isSimulate">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="emailSimulation" returnType="java.lang.Boolean">
                <content>emailSimulation</content>
              </expression>
            </input>
            <input name="documentType">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="documentTypeId" returnType="java.lang.String">
                <content>documentTypeId</content>
              </expression>
            </input>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="roundNumber">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="currentUser">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getApproverName" returnType="java.lang.String">
                <content>

return apiAccessor.getIdentityAPI().getUser(emailUserId).getUserName();</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
                <expression expressionType="TYPE_VARIABLE" name="emailUserId" returnType="java.lang.Long">
                  <content>emailUserId</content>
                </expression>
              </expression>
            </input>
            <input name="notifyBuyer">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="true" returnType="java.lang.Boolean">
                <content>true</content>
              </expression>
            </input>
            <input name="maskEmail">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="false" returnType="java.lang.Boolean">
                <content>false</content>
              </expression>
            </input>
            <input name="notifyApproversRoundInProgress">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="true" returnType="java.lang.Boolean">
                <content>true</content>
              </expression>
            </input>
            <input name="emailTemplateId">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="7" returnType="java.lang.String">
                <content>7</content>
              </expression>
            </input>
            <input name="activityInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="activityInstanceId" returnType="java.lang.Long">
                <content>activityInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="activityInstanceId" returnType="java.lang.Long">
                  <content>activityInstanceId</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions/>
        <operations/>
        <boundaryEvents/>
      </automaticTask>
      <automaticTask id="-7033842577446123688" name="Notify Reject">
        <incomingTransition idref="7928879063792894587"/>
        <outgoingTransition idref="8983049531292368220"/>
        <dataDefinitions/>
        <operations/>
        <boundaryEvents/>
      </automaticTask>
      <automaticTask id="-4793214544702840173" name="Notify temp readers">
        <incomingTransition idref="6605133078376070701"/>
        <outgoingTransition idref="33987063028400520"/>
        <connector activationEvent="ON_FINISH" connectorId="PAWnotifyUserByEmail" failAction="IGNORE" name="Email - Notify Readers (5)" version="1.0.0">
          <inputs>
            <input name="overviewLink">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="get overview link from parent" returnType="java.lang.String">
                <content>import hu.mol.capgemini.paw.BSD;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");

ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

String value = null;

if(parentProcessInstanceId != null)

{

	value = processAPI.getProcessDataInstance("overviewLink", parentProcessInstanceId).getValue();

}

logger.info("overview value=" + value);

return value;</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
            <input name="isSimulate">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="emailSimulation" returnType="java.lang.Boolean">
                <content>emailSimulation</content>
              </expression>
            </input>
            <input name="documentType">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="documentTypeId" returnType="java.lang.String">
                <content>documentTypeId</content>
              </expression>
            </input>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="roundNumber">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="maskEmail">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="false" returnType="java.lang.Boolean">
                <content>false</content>
              </expression>
            </input>
            <input name="usersListToSend">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="tempReaders" returnType="java.util.List">
                <content>tempReaders</content>
              </expression>
            </input>
            <input name="emailTemplateId">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="5" returnType="java.lang.String">
                <content>5</content>
              </expression>
            </input>
            <input name="activityInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="activityInstanceId" returnType="java.lang.Long">
                <content>return activityInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="activityInstanceId" returnType="java.lang.Long">
                  <content>activityInstanceId</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions/>
        <operations/>
        <boundaryEvents/>
      </automaticTask>
      <automaticTask id="-5743876393628887063" name="Update reference document">
        <incomingTransition idref="5823556763602206785"/>
        <outgoingTransition idref="2921976654775107366"/>
        <dataDefinitions/>
        <operations>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="tempStatusId"/>
            <rightOperand expressionType="TYPE_VARIABLE" interpreter="" name="decision" returnType="java.lang.String">
              <content>decision</content>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
      </automaticTask>
      <userTask actorName="Approver" expectedDuration="0" id="-6244483721764461375" name="Approve document (ENDORSEMENT)" priority="NORMAL">
        <displayName expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="setTaskName" returnType="java.lang.String">
          <content>String docTypeLetter = "";



return "Approve "+bsdDocument.getDocumentTypeId()+" (ENDORSEMENT) ("+docTypeLetter+bsdDocument.getDocumentId() + ")";</content>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayName>
        <displayDescription expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getDescription" returnType="java.lang.String">
          <content>import hu.mol.capgemini.common.bonita.FormScripts;



String description = "ID: ";



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

//description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;</content>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
            <content>taskAssigneeId</content>
          </expression>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
            <content>apiAccessor</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayDescription>
        <displayDescriptionAfterCompletion expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getDescription" returnType="java.lang.String">
          <content>import hu.mol.capgemini.common.bonita.FormScripts;



String description;



// Request

if (bsdDocument.getDocumentTypeId().equals("BSD")) {description = "ID: B";}

if (bsdDocument.getDocumentTypeId().equals("SSD")) {description = "ID: S";}

if (bsdDocument.getDocumentTypeId().equals("LVP")) {description = "ID: L";}



// DocID

description += bsdDocument.getDocumentId() + "\n";

// Subject

description += "Subject: " +  bsdDocument.getSubject() + "\n";



// Total EUR

description += "EUR: " + FormScripts.formatCurrency(bsdDocument.getTotalValueInEuros()) + "\n";



// User

//description += "User: " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getFirstName() + " " + apiAccessor.getIdentityAPI().getUser(taskAssigneeId).getLastName() + "\n";



// Status

description += "Status: " + bsdDocument.getStatusId();



return description;</content>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
            <content>taskAssigneeId</content>
          </expression>
          <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
            <content>apiAccessor</content>
          </expression>
          <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
            <content>bsdDocument</content>
          </expression>
        </displayDescriptionAfterCompletion>
        <incomingTransition idref="247685219176104686"/>
        <incomingTransition idref="6673101584410525057"/>
        <outgoingTransition idref="6227390173416501893"/>
        <connector activationEvent="ON_FINISH" connectorId="PAW-CalculDocumentId" failAction="IGNORE" name="calculDocumentId" version="1.0.0">
          <inputs>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="processInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getProcessInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
          </inputs>
          <outputs>
            <operation operatorType="ASSIGNMENT">
              <leftOperand name="bsdDocument"/>
              <rightOperand expressionType="TYPE_INPUT" interpreter="" name="bsdDocumentUpdated" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocumentUpdated</content>
              </rightOperand>
            </operation>
          </outputs>
        </connector>
        <connector activationEvent="ON_FINISH" connectorId="PAW-UpdateDocument" failAction="IGNORE" name="saveDocumentENDORSEMENT" version="1.0.0">
          <inputs>
            <input name="documentType">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="documentType" returnType="java.lang.String">
                <content>documentType</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="modifierUserName">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="getuserName" returnType="java.lang.String">
                <content>import org.bonitasoft.engine.api.IdentityAPI;

import org.bonitasoft.engine.identity.User;



IdentityAPI identityAPI = apiAccessor.getIdentityAPI();



User user = identityAPI.getUser(taskAssigneeId);

if (user!=null)

  return user.getUserName();

return "Unknown";</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="taskAssigneeId" returnType="java.lang.Long">
                  <content>taskAssigneeId</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <connector activationEvent="ON_ENTER" connectorId="PAWnotifyUserByEmail" failAction="IGNORE" name="Email - Approval request (Endorsment) (31)" version="1.0.0">
          <inputs>
            <input name="isSimulate">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="emailSimulation" returnType="java.lang.Boolean">
                <content>emailSimulation</content>
              </expression>
            </input>
            <input name="documentType">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="documentTypeId" returnType="java.lang.String">
                <content>documentTypeId</content>
              </expression>
            </input>
            <input name="logLife">
              <expression expressionType="TYPE_PARAMETER" interpreter="" name="logLife" returnType="java.lang.Boolean">
                <content>logLife</content>
              </expression>
            </input>
            <input name="roundNumber">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
            </input>
            <input name="bsdDocument">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
            </input>
            <input name="maskEmail">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="see script ..." returnType="java.lang.Boolean">
                <content>// ha kezdodik a process, akkor kell kuldeni ezt az emailt.

if (sendApprovalRequest) { return false; }

return true;</content>
                <expression expressionType="TYPE_VARIABLE" name="sendApprovalRequest" returnType="java.lang.Boolean">
                  <content>sendApprovalRequest</content>
                </expression>
              </expression>
            </input>
            <input name="usersListToSend">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="current approver" returnType="java.util.List">
                <content>return [approvalPerformer.getApproverId()]</content>
                <expression expressionType="TYPE_VARIABLE" name="approvalPerformer" returnType="hu.mol.capgemini.paw.Approver">
                  <content>approvalPerformer</content>
                </expression>
              </expression>
            </input>
            <input name="emailTemplateId">
              <expression expressionType="TYPE_CONSTANT" interpreter="" name="31" returnType="java.lang.String">
                <content>31</content>
              </expression>
            </input>
            <input name="activityInstanceId">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="activityInstanceId" returnType="java.lang.Long">
                <content>activityInstanceId</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="activityInstanceId" returnType="java.lang.Long">
                  <content>activityInstanceId</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <connector activationEvent="ON_FINISH" connectorId="scripting-groovy" failAction="IGNORE" name="synchronize bsdDocument to root process" version="1.0.0">
          <inputs>
            <input name="script">
              <expression expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="do synchronization" returnType="java.lang.Object">
                <content>import hu.mol.capgemini.paw.BSD;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;



ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

if(parentProcessInstanceId != null)

{

//	processAPI.updateProcessDataInstance("bsdDocument", processInstanceId, processAPI.getProcessDataInstance("bsdDocument", parentProcessInstanceId).getValue());

	processAPI.updateProcessDataInstance("bsdDocument", parentProcessInstanceId, bsdDocument);

}</content>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                  <content>processInstanceId</content>
                </expression>
                <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                  <content>bsdDocument</content>
                </expression>
                <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                  <content>apiAccessor</content>
                </expression>
              </expression>
            </input>
          </inputs>
          <outputs/>
        </connector>
        <dataDefinitions>
          <dataDefinition className="java.util.Date" name="startDate" transient="false">
            <defaultValue expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="Now" returnType="java.util.Date">
              <content>new Date()</content>
            </defaultValue>
          </dataDefinition>
        </dataDefinitions>
        <operations>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="remainingTimeInMiliseconds"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="updateRemainingTimeAfterDecision" returnType="java.lang.Long">
              <content>Long executionT = new Date().getTime() - startDate.getTime();

return remainingTimeInMiliseconds-executionT;</content>
              <expression expressionType="TYPE_VARIABLE" name="startDate" returnType="java.util.Date">
                <content>startDate</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="remainingTimeInMiliseconds" returnType="java.lang.Long">
                <content>remainingTimeInMiliseconds</content>
              </expression>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="sendApprovalRequest"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="false" returnType="java.lang.Boolean">
              <content>false</content>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="bsdDocument"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="update bsddocument" returnType="hu.mol.capgemini.paw.BSD">
              <content>import groovyjarjarantlr.Utils;

import hu.mol.capgemini.common.bonita.FormScripts;

import hu.mol.capgemini.enums.PawStatus;

import hu.mol.capgemini.paw.ApprovalRound;

import hu.mol.capgemini.paw.BSD;

import hu.mol.capgemini.paw.DocumentAttachment;

import hu.mol.capgemini.paw.Note;



import org.bonitasoft.engine.bpm.process.ProcessInstance;

import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");





logger.info(username + " OPERATION STARTED");



// ha notify, akkor nem frissitunk

if (decision.equals("NOTIFY")) { return bsdDocument; }





ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();

BSD tmp = (BSD)processAPI.getProcessDataInstance("bsdDocument", parentProcessInstanceId).getValue();



/**********************/

/* NOTES              */

/**********************/

if (tempNote != null) {

	logger.info(username + " synchronizing notes ...");

	bsdDocument.setNotes(FormScripts.addNoteToList(tmp.getNotes(), tempNote.getNote(), tempNote.getAuthorId(), true));

	logger.info(username + " notes synchronized");

}



/**********************/

/* APPROVAL DATE      */

/**********************/

logger.info(username + " synchronizing approvers ...");

List&lt;ApprovalRound&gt; arlist = tmp.getApprovalRounds();

if (decision.equals(PawStatus.APPROVED.getStatusId())) {	ApprovalRound ar = arlist.get(roundNumber);

	logger.info(username + " round approvers BEFORE=" + ar.getApprovers());

	for (int i = 0; i &lt; ar.getApprovers().size(); i++) {

		if (ar.getApprovers().get(i).getApproverId().equals(username)) {

			ar.getApprovers().get(i).setDecisionDate(new Date());

		}

	}

	logger.info(username + " round approvers AFTER=" + ar.getApprovers());

	arlist.remove(roundNumber);

	arlist.add(roundNumber, ar);

}

bsdDocument.setApprovalRounds(arlist);

logger.info(username + " approvers synchronized");



/**********************/

/* ATTACHMENTS        */

/**********************/

/*

logger.info(username + " synchronizing attachments ...");

List&lt;DocumentAttachment&gt; attachments = tmp.getAttachments();

if (tempDocumentAttachment.size() &gt; 0) {

	for (int i = 0; i &lt; tempDocumentAttachment.size(); i++) {

		attachments.add(tempDocumentAttachment.get(i));

	}

}

bsdDocument.setAttachments(attachments);

logger.info(username + " attachments synchronized");

*/

return bsdDocument;</content>
              <expression expressionType="TYPE_VARIABLE" name="username" returnType="java.lang.String">
                <content>username</content>
              </expression>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="roundNumber" returnType="java.lang.Integer">
                <content>roundNumber</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="tempDocumentAttachment" returnType="java.util.List">
                <content>tempDocumentAttachment</content>
              </expression>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                <content>apiAccessor</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="tempNote" returnType="hu.mol.capgemini.paw.Note">
                <content>tempNote</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="decision" returnType="java.lang.String">
                <content>decision</content>
              </expression>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents>
          <boundaryEvent id="-6911786250896212301" interrupting="true" name="Remaining time">
            <outgoingTransition idref="4188599158229585622"/>
            <timerEventTrigger type="DURATION">
              <expression expressionType="TYPE_VARIABLE" interpreter="" name="remainingTimeInMiliseconds" returnType="java.lang.Long">
                <content>remainingTimeInMiliseconds</content>
              </expression>
            </timerEventTrigger>
          </boundaryEvent>
        </boundaryEvents>
        <userFilter name="Get approver and substitutor" userFilterId="ApprovalUserFilter" version="1.0.0">
          <inputs>
            <input name="firstUser">
              <expression expressionType="TYPE_JAVA_METHOD_CALL" interpreter="" name="approvalPerformer - hu.mol.capgemini.paw.Approver#getApproverId" returnType="java.lang.String">
                <content>getApproverId</content>
                <expression expressionType="TYPE_VARIABLE" name="approvalPerformer" returnType="hu.mol.capgemini.paw.Approver">
                  <content>approvalPerformer</content>
                </expression>
              </expression>
            </input>
          </inputs>
        </userFilter>
      </userTask>
      <automaticTask id="-7937240740535008576" name="set init parms">
        <incomingTransition idref="2146514707197899293"/>
        <outgoingTransition idref="3360247391569688287"/>
        <dataDefinitions/>
        <operations>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="sendApprovalRequest"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="true" returnType="java.lang.Boolean">
              <content>true</content>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="approvalProcessId"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="processInstanceId" returnType="java.lang.Long">
              <content>processInstanceId</content>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
              </expression>
            </rightOperand>
          </operation>
          <operation operatorType="ASSIGNMENT">
            <leftOperand name="bsdDocument"/>
            <rightOperand expressionType="TYPE_READ_ONLY_SCRIPT" interpreter="GROOVY" name="update bsddocument attachments" returnType="hu.mol.capgemini.paw.BSD">
              <content>/*

import org.bonitasoft.engine.bpm.document.ArchivedDocument;

import org.bonitasoft.engine.bpm.document.Document;

import org.bonitasoft.engine.bpm.document.DocumentsSearchDescriptor;

import org.bonitasoft.engine.bpm.process.ProcessInstance;

import org.bonitasoft.engine.search.Order;

import org.bonitasoft.engine.search.SearchOptionsBuilder;

import org.bonitasoft.engine.search.impl.SearchResultImpl;



import hu.mol.capgemini.paw.DocumentAttachment;



import com.bonitasoft.engine.api.ProcessAPI;

import java.util.logging.Logger;



Logger logger = Logger.getLogger("groovy");



ProcessAPI processAPI = apiAccessor.getProcessAPI();

ProcessInstance processInstance = processAPI.getProcessInstance(processInstanceId);

Long parentProcessInstanceId = processInstance.getRootProcessInstanceId();



ProcessAPI pAPI = apiAccessor.getProcessAPI();

List&lt;DocumentAttachment&gt; attachments = bsdDocument.getAttachments();

for (int i = 0; i &lt; attachments.size(); i++) {

	SearchOptionsBuilder sob = new SearchOptionsBuilder(0, 10);

	logger.info("attachmentid=" + bsdDocument.getAttachments().get(i).getAttachmentId());

	sob.filter(DocumentsSearchDescriptor.DOCUMENT_NAME, bsdDocument.getAttachments().get(i).getAttachmentId());

	sob.filter(DocumentsSearchDescriptor.PROCESSINSTANCE_ID, parentProcessInstanceId);

	sob.sort(DocumentsSearchDescriptor.DOCUMENT_CREATIONDATE,Order.DESC);

	SearchResultImpl&lt;Document&gt; searchResult;

	try {

		searchResult = pAPI.searchDocuments(sob.done());

		if (searchResult.getResult().size() &gt; 0) {

			Document source = searchResult.getResult().get(0);

			logger.info("document found: " + source.getContentFileName());

			byte[] content = pAPI.getDocumentContent(source.getContentStorageId());

			Document d = pAPI.attachDocument(processInstanceId, source.getName(), source.getContentFileName(), source.getContentMimeType(), content);

			attachments.get(i).setAttachmentId(d.getName());

		}

	}

	catch (Exception e) {

		logger.info("error: " + e);

		e.printStackTrace();

	}

}

bsdDocument.setAttachments(attachments);

*/

return bsdDocument;</content>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="processInstanceId" returnType="java.lang.Long">
                <content>processInstanceId</content>
              </expression>
              <expression expressionType="TYPE_VARIABLE" name="bsdDocument" returnType="hu.mol.capgemini.paw.BSD">
                <content>bsdDocument</content>
              </expression>
              <expression expressionType="TYPE_ENGINE_CONSTANT" interpreter="" name="apiAccessor" returnType="com.bonitasoft.engine.api.APIAccessor">
                <content>apiAccessor</content>
              </expression>
            </rightOperand>
          </operation>
        </operations>
        <boundaryEvents/>
      </automaticTask>
      <gateway gatewayType="EXCLUSIVE" id="-9034311412311222689" name="Buyer decision?">
        <incomingTransition idref="9017617765412718890"/>
        <outgoingTransition idref="1058165947009383241"/>
        <outgoingTransition idref="7846824731330133000"/>
        <outgoingTransition idref="5914148668858974313"/>
        <defaultTransition idref="4859120828444622406"/>
      </gateway>
      <gateway gatewayType="EXCLUSIVE" id="-5454138644782442414" name="Buyer decision ?">
        <incomingTransition idref="3393046723358997647"/>
        <outgoingTransition idref="1106415390683054200"/>
        <defaultTransition idref="2640281412267034269"/>
      </gateway>
      <gateway gatewayType="EXCLUSIVE" id="-5073744529954463830" name="Decision?">
        <incomingTransition idref="4486983273537322201"/>
        <outgoingTransition idref="4079279116503895604"/>
        <outgoingTransition idref="6516218567500348508"/>
        <defaultTransition idref="7928879063792894587"/>
      </gateway>
      <gateway gatewayType="EXCLUSIVE" id="-4853102777829641927" name="Performer type?">
        <incomingTransition idref="3360247391569688287"/>
        <outgoingTransition idref="4869871656688138994"/>
        <defaultTransition idref="8358566522595882237"/>
      </gateway>
      <gateway gatewayType="EXCLUSIVE" id="-8857735301002221628" name="Decision type?">
        <incomingTransition idref="6072645225894491903"/>
        <incomingTransition idref="8358566522595882237"/>
        <outgoingTransition idref="6060732935121159297"/>
        <defaultTransition idref="247685219176104686"/>
      </gateway>
      <gateway gatewayType="EXCLUSIVE" id="-6757258532079730945" name="Notify new readers?">
        <incomingTransition idref="5854302617790820562"/>
        <incomingTransition idref="6227390173416501893"/>
        <outgoingTransition idref="6605133078376070701"/>
        <defaultTransition idref="5823556763602206785"/>
      </gateway>
      <gateway gatewayType="EXCLUSIVE" id="-7483767250699881262" name="Only notified (not decision yet)?">
        <incomingTransition idref="33987063028400520"/>
        <incomingTransition idref="2921976654775107366"/>
        <outgoingTransition idref="1899752015532606001"/>
        <outgoingTransition idref="6673101584410525057"/>
        <defaultTransition idref="4486983273537322201"/>
      </gateway>
      <startEvent id="-5831461165192240468" interrupting="true" name="Start approval">
        <outgoingTransition idref="2146514707197899293"/>
      </startEvent>
      <endEvent id="-7630786683555758561" name="Recall">
        <incomingTransition idref="1106415390683054200"/>
        <incomingTransition idref="8603990903615799487"/>
        <terminateEventTrigger/>
      </endEvent>
      <endEvent id="-6432263633414116404" name="Cancelled">
        <incomingTransition idref="8444224341373271416"/>
        <terminateEventTrigger/>
      </endEvent>
      <endEvent id="-7041263772579361788" name="Approved">
        <incomingTransition idref="12296300144014775"/>
        <terminateEventTrigger/>
      </endEvent>
      <endEvent id="-8446473019470579858" name="Rejected">
        <incomingTransition idref="8983049531292368220"/>
        <terminateEventTrigger/>
      </endEvent>
      <endEvent id="-8151172276074376967" name="Approved automatically">
        <incomingTransition idref="5269428346146962211"/>
        <terminateEventTrigger/>
      </endEvent>
    </flowNodes>
  </flowElements>
  <dependencies>
    <parameters>
      <parameter name="pawBusinessDataType" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="i18nDataSource" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="pawType" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="environmentDataSource" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="logLife" type="java.lang.Boolean">
        <description/>
      </parameter>
      <parameter name="substitutionType" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="pawBusinessDataDataSource" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="substitutionDataSource" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="emailSimulation" type="java.lang.Boolean">
        <description/>
      </parameter>
      <parameter name="documentTypeId" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="i18nApp" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="pawDataSource" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="mailTemplateDataSource" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="mailTemplateType" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="i18nType" type="java.lang.String">
        <description/>
      </parameter>
      <parameter name="environmentType" type="java.lang.String">
        <description/>
      </parameter>
    </parameters>
    <actors>
      <actor name="Approver">
        <description/>
      </actor>
      <actor name="Buyer">
        <description/>
      </actor>
    </actors>
  </dependencies>
</processDefinition>
