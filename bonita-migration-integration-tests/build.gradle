import groovy.sql.Sql

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'maven'

group = 'org.bonitasoft.migration'
version = '1.0.0-SNAPSHOT'

sourceCompatibility = 1.6
targetCompatibility = 1.6

ext{
    sourceversion = System.getProperty("source.version","6.0.2")
    targetversion = System.getProperty("target.version","6.1.0")
    dbvendor = System.getProperty("db.vendor", "mysql")
    dburl = System.getProperty("db.url","jdbc:mysql://localhost:3306/bonita_migration?allowMultiQueries=true");
    dbuser=System.getProperty("db.user","root")
    dbpassword=System.getProperty("db.password", "root")
    dbdriverClass=System.getProperty("db.driverClass","com.mysql.jdbc.Driver")
    bonitahome="${buildDir.path}/home"
    distDir="${buildDir.path}/dist"
}

configurations {
    sourcefiller
    targetfiller
    migrationdist
    drivers
    homezip
}

repositories {
    mavenLocal()
    if(System.getProperty("maven.repository")!=null){
        def customRepo = System.getProperty("maven.repository")
        println "using custom maven repository: $customRepo"
        maven { url customRepo }
    }else{
        println "no custom repository defined, use system property 'maven.repository' to add one"
    }
    mavenCentral()
}
dependencies {
    sourcefiller "org.bonitasoft.migration:bonita-migration-db-filler-${sourceversion}:1.0.0-SNAPSHOT"
    homezip  group: 'org.bonitasoft.engine', name: 'bonita-home', version: sourceversion, ext: 'zip'
    targetfiller "org.bonitasoft.migration:bonita-migration-db-filler-${targetversion}:1.0.0-SNAPSHOT"
    migrationdist group: 'org.bonitasoft.migration', name: "bonita-migration-distrib", version: "1.0.0-SNAPSHOT", ext: 'zip'
    drivers group: 'mysql', name: 'mysql-connector-java', version: '5.1.26'
    drivers group: 'org.postgresql', name: 'postgresql', version: '9.2-1003-jdbc4'
}

URLClassLoader loader = GroovyObject.class.classLoader
configurations.drivers.each {File file ->
    loader.addURL(file.toURI().toURL())
}
task cleardb(){
    println "dburl=$dburl"
    def parsedUrl = (dburl =~ /(jdbc:\w+:\/\/[\w\d\.]+:\d+\/)([\w-_\d]+).*/)
    def genericUrl = parsedUrl[0][1]
    def databaseName = parsedUrl[0][2]
    println "recreate database $databaseName on $genericUrl with driver $dbdriverClass"
    def props = [user: dbuser, password: dbpassword] as Properties
    def sql = Sql.newInstance(genericUrl, props, dbdriverClass)
    try{
        sql.executeUpdate("drop database `"+databaseName+"`")
    }catch(Exception e){
        println "can't drop database, maybe it did not exist"
    }
    sql.executeUpdate("create database `"+databaseName+"` DEFAULT CHARACTER SET utf8")
    
}
task unpackhome(dependsOn:cleardb,type: Copy){
    def zipFile = configurations.homezip.files.iterator().next()
    def outputDir = file("${buildDir.path}")

    from zipTree(zipFile)
    into outputDir
}

task execfill(dependsOn:unpackhome, type: JavaExec) {
    println "execute fill of the database using classpath "
    configurations.sourcefiller.each {
        println it
    }
    classpath configurations.sourcefiller
    systemProperties(["sysprop.bonita.db.vendor":dbvendor,
        "jdbc.vendor":dbvendor,
        "jdbc.url":dburl,
        "jdbc.user":dbuser,
        "jdbc.password":dbpassword,
        "jdbc.driverClass":dbdriverClass,
        "bonita.home":bonitahome])
    main = "org.bonitasoft.migration.DatabaseFiller"
}
task unpackdist(dependsOn:execfill, type: Copy){
    def zipFile = configurations.migrationdist.files.iterator().next()
    def outputDir = file(distDir)

    from zipTree(zipFile)
    into outputDir
}
task copyDrivers(dependsOn:unpackdist, type: Copy){
    into "$distDir/lib"
    from configurations.drivers
}

task changeproperties(dependsOn:copyDrivers)<<{
    def propFile = new File(distDir,"Config.properties")
    def fis = new FileInputStream(propFile)
    def Properties props = new Properties()
    props.load(fis)
    fis.close()
    props.put("source.version",String.valueOf(sourceversion))
    props.put("target.version",String.valueOf(targetversion))
    props.put("db.vendor",String.valueOf(dbvendor));
    props.put("db.url",String.valueOf(dburl));
    props.put("db.user",String.valueOf(dbuser));
    props.put("db.password",String.valueOf(dbpassword));
    props.put("db.driverClass",String.valueOf(dbdriverClass));
    props.put("bonita.home",String.valueOf(bonitahome));
    props.store(new FileWriter(propFile), "config");
}
task runmigration(dependsOn:changeproperties, type:JavaExec){
    workingDir distDir
    main = 'groovy.lang.GroovyShell'
    classpath = files([
        "build/dist/lib/groovy-all-1.8.6.jar"
    ]as String[])
    args 'Migration.groovy'
    systemProperty 'auto.accept', 'true'
}

//test.dependsOn(runmigration)
////task testmigration(dependsOn:runmigration, type: JavaExec) {
////    classpath configurations.targetfiller
////    systemProperties(["sysprop.bonita.db.vendor":dbvendor,
////        "jdbc.vendor":dbvendor,
////        "jdbc.url":dburl,
////        "jdbc.user":dbuser,
////        "jdbc.password":dbpassword,
////        "jdbc.driverClass":dbdriverClass,
////        "bonita.home":bonitahome])
////    main = "org.bonitasoft.migration.DatabaseChecker"+targetversion.replace('.', '_')
////}
//test <<{
//    systemProperties(["sysprop.bonita.db.vendor":dbvendor,
//        "jdbc.vendor":dbvendor,
//        "jdbc.url":dburl,
//        "jdbc.user":dbuser,
//        "jdbc.password":dbpassword,
//        "jdbc.driverClass":dbdriverClass,
//        "bonita.home":bonitahome])
//    classpath = configurations.targetfiller
//    include "org.bonitasoft.migration.DatabaseChecker"+targetversion.replace('.', '_')
//    testLogging.showStandardStreams = true
//}


